<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="GB2312"> <!-- Set character encoding to GB2312 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Make the webpage adapt to various device widths -->
    <title>YuanRetro - Morse Code</title> <!-- Webpage title -->
    <link rel="stylesheet" href="./style.css"> <!-- Link to external stylesheet -->
    <style>
        /* Styles defined directly here */
        #textInput {
            font-family: GenshinImpactZhLv1; /* Set input box font */
            font-size: 16px; /* Set input box font size */
        }
        label, input, button {
            display: inline-block; /* Set elements to block-level, allowing width settings */
            vertical-align: middle; /* Vertically center align */
            margin-bottom: 10px; /* Set bottom margin */
        }
    
        label {
            width: 250px; /* Label width */
        }
    
        input {
            width: 100px; /* Input box width */
            margin-right: 40px; /* Distance from the button */
        }
    
        button {
            width: 80px; /* Button width */
        }
    
        #error {
            color: red; /* Error message color */
            margin-top: 10px; /* Top margin for error message */
        }
    
    </style>
</head>
<body class="body">
    <!-- Navigation menu -->
    <ul>
        <li class="navi"><a href="http://www.yuanshen.dev/en/index.html">Main</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/en/music.html">Music</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/en/pinball.html">JS Pinball Game</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/en/morse.html">Morse Code</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/en/crtirgen.html">中国铁路行程信息提示生成器(CRTIRGen)</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/en/about.html">About</a></li>
        <li class="navi"><a href="http://www.yuanshen.dev/">简体中文</a></li>
    </ul>
    <br />
    
    <h1>Text to Morse Code</h1> <!-- Main title -->
    
    <!-- Input area -->
    <textarea id="textInput" placeholder="Enter text to convert" rows="10" cols="30"></textarea>
    <br />
    
    <label for="WPM">Sending speed (WPM, words per minute):</label>
    <input type="number" id="WPM" value="20" min="1"/> <!-- Default speed is 20 WPM -->
    <br />
    
    <label for="fq">Code pitch (Hz, Hertz):</label>
    <input type="number" id="fq" value="600" min="1"/> <!-- Default pitch is 600 Hz -->
    
    <!-- Buttons -->
    <button class="custom-button" onclick="preparation()">Play</button> 
    <button class="custom-button" onclick="pauseSound()">Pause</button> 
    <button class="custom-button" onclick="resumeSound()">Resume</button> 
    <button class="custom-button" onclick="stopSound()">Stop</button> 
    <div id="error"></div> <!-- Area for displaying error messages -->

    <script>
        // Define the mapping for Morse code
        const morseCode = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.',
            'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---',
            'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---',
            'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-',
            'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--',
            'Z': '--..', '0': '-----', '1': '.----', '2': '..---', 
            '3': '...--', '4': '....-', '5': '.....', '6': '-....', 
            '7': '--...', '8': '---..', '9': '----.', '.': '.-.-.-',
            ',': '--..--', '?': '..--..', '\'': '.----.', '!': '-.-.--',
            '/': '-..-.', '(': '-.--.', ')': '-.--.-', '&': '.-...',
            ':': '---...', ';': '-.-.-.', '=': '-...-', '+': '.-.-.',
            '-': '-....-', '_': '..--.-', '"': '.-..-.', '$': '...-..-',
            '@': '.--.-.'
        };

        let audioContext; // For audio context
        let currentTimeouts = []; // For storing current timers
        let isPlaying = false; // Whether it is currently playing
        let currentIndex = 0; // Current note index
        let words = []; // Store the words to be played
        let dotDuration, dashDuration, elementGap, letterGap, wordGap; // Durations and gaps for notes
        let currentFrequency = 600; // Current audio frequency

        // Create audio context
        function createAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Convert text to Morse code
        function textToMorse(text) {
            return text.toUpperCase().split('').map(char => morseCode[char] || ' ').join(' ');
        }

        // Play sound
        function playSound(frequency, duration) {
            const oscillator = audioContext.createOscillator(); // Create an oscillator
            oscillator.type = 'sine'; // Set wave type to sine
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime); // Set frequency
            oscillator.connect(audioContext.destination); // Connect to the audio context's destination
            oscillator.start(); // Start playing
            oscillator.stop(audioContext.currentTime + duration); // Stop playing
        }

        // Calculate the duration of a dot (in milliseconds)
        function getDotDuration(wpm) {
            return 1200 / wpm; // Calculate duration of a dot
        }

        // Play Morse code
        function playNextSymbol() {
            // Exit if paused or finished playing
            if (!isPlaying || currentIndex >= words.length) {
                return;
            }

            const symbol = words[currentIndex]; // Get current note
            if (symbol === '.') { // Play dot
                playSound(currentFrequency, dotDuration / 1000);
                currentIndex++; // Move to next note
                setTimeout(playNextSymbol, dotDuration + elementGap); // Wait to play the next note
            } else if (symbol === '-') { // Play dash
                playSound(currentFrequency, dashDuration / 1000);
                currentIndex++; // Move to next note
                setTimeout(playNextSymbol, dashDuration + elementGap); // Wait to play the next note
            } else if (symbol === ' ') { // Add gap between letters
                currentIndex++;
                setTimeout(playNextSymbol, letterGap); // Wait to play the next note
            } else if (symbol === '   ') { // Add gap between words
                currentIndex++;
                setTimeout(playNextSymbol, wordGap); // Wait to play the next note
            }
        }

        // Play Morse code
        function playMorse(wpm, freq) {
            dotDuration = getDotDuration(wpm); // Calculate dot duration
            dashDuration = 3 * dotDuration; // Dash duration is three times that of a dot
            elementGap = dotDuration; // Gap between elements
            letterGap = 3 * dotDuration; // Gap between letters
            wordGap = 7 * dotDuration; // Gap between words (7 times the duration of a dot)

            const text = document.getElementById('textInput').value.trim(); // Get input text
            const morseText = text.split(' ').map(word => textToMorse(word)).join('   '); // Convert to Morse code
            words = morseText.split(''); // Split Morse code into individual characters
            currentFrequency = freq; // Set current frequency
            currentIndex = 0; // Reset current index
            isPlaying = true; // Mark as playing
            playNextSymbol(); // Start playing notes
        }

        // Validate user input
        function validateInput(text) {
            // Regular expression: allow letters, numbers, and specific symbols
            const validChars = /^[A-Za-z0-9.,?'!()/&:;=+-_"$@ ]*$/;
            return validChars.test(text); // Return whether the input is valid
        }

        // Prepare to play audio
        function preparation() {
            const textInput = document.getElementById('textInput').value; // Get user input text

            // Validate user input
            if (!validateInput(textInput)) {
                document.getElementById('error').innerText = 'Please enter valid characters only!';
                return; // Exit if input is invalid
            } else {
                document.getElementById('error').innerText = ''; // Clear error message
            }

            // Get WPM and frequency values
            const wpm = parseInt(document.getElementById('WPM').value);
            const freq = parseInt(document.getElementById('fq').value);

            // Create audio context if not already created
            if (!audioContext) {
                createAudioContext(); // Create audio context
            }

            // Play Morse code
            playMorse(wpm, freq);
        }

        // Pause playback
        function pauseSound() {
            isPlaying = false; // Mark as paused
        }

        // Resume playback
        function resumeSound() {
            if (!isPlaying) {
                isPlaying = true; // Mark as playing
                playNextSymbol(); // Resume playing
            }
        }

        // Stop playback
        function stopSound() {
            isPlaying = false; // Mark as not playing
            currentIndex = 0; // Reset current index
            words = []; // Clear words
        }
    </script>
</body>
</html>
